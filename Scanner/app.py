from flask import Flask, render_template, request
import os.path
from amsiscan import AMSIScanner
from subprocess import Popen
from pathlib import Path

app = Flask(__name__)

def GetProjectRoot() -> Path:
    return Path(__file__).parent.parent

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload_file():
    print(GetProjectRoot())
    uploadDir = str(GetProjectRoot()) + "\\Scanner\\uploads\\"
    if request.method == 'POST':
        file = request.files['file']
        if file:
            file.save("uploads/" + file.filename)
            fullFilePath = uploadDir + file.filename
            if(os.path.isfile("uploads/" + file.filename)):
                with AMSIScanner() as scanner:
                    with open(fullFilePath, mode='rb') as file:
                        fileContent = file.read()
                    res = scanner.scan(fileContent)
                    if(int(res.value) == 1):
                        p = Popen(['cmd.exe', '/c', fullFilePath])
                        return render_template('success.html')
                    elif(int(res.value) == 32768):
                        return render_template('fail.html')
                           
            else:
                return render_template('upload_message.html', message='No file uploaded!')

if __name__ == '__main__':
    
    app.run(host='0.0.0.0', port=8000)